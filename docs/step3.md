# ステップ３
データを抽出するクエリを作成する。

## 1.よく見られているエピソードを知りたい
エピソード視聴数トップ3のエピソードタイトルと視聴数を取得する。
### クエリ
```sql
SELECT
    episode_name AS "エピソードタイトル", viewers AS "視聴数"
FROM
    episodes
ORDER BY
	viewers DESC
LIMIT 3;
```
### 結果
| エピソードタイトル                      | 視聴数    |
|---------------------------------------|-----------|
| ライブエクスペリエンス                  |    600000 |
| イントロダクション                      |    500000 |
| 豪華ゲストとのトークショー              |    190000 |

3 rows in set (0.00 sec)

## 2.よく見られているエピソードの番組情報やシーズン情報も合わせて知りたい
エピソード視聴数トップ3の番組タイトル、シーズン数、エピソード数、エピソードタイトル、視聴数を取得する。
### クエリ
```sql
SELECT
    p.program_name AS "番組名", season_no AS "シーズン数", e1.episode_no AS "エピソード数",
		e1.episode_name AS "エピソードタイトル", e1.viewers AS "視聴数"
FROM
    episodes AS e1 INNER JOIN programs AS p ON e1.program_no = p.program_no
ORDER BY
	viewers DESC
LIMIT 3;
```
### 結果
| 番組名            | シーズン数      | エピソード数       | エピソードタイトル             | 視聴数    |
|------------------|-----------------|--------------------|---------------------------|-----------|
| 音楽ライブ「響きの探求者」|               1 |                  2 | ライブエクスペリエンス  |    600000 |
| 音楽ライブ「響きの探求者」 |               1 |                  1 | イントロダクション     |    500000 |
| バラエティ「人気者集合」 |               1 |                 40 | 豪華ゲストとのトークショー |    190000 |

3 rows in set (0.00 sec)

## 3.本日の番組表を表示したい
本日、どのチャンネルの、何時から、何の番組が放送されるのかを知りたい。
本日放送される全ての番組に対して、チャンネル名、放送開始時刻(日付+時間)、放送終了時刻、シーズン数、エピソード数、エピソードタイトル、エピソード詳細を取得する。なお、番組の開始時刻が本日のものを本日方法される番組とみなすものとする。
### クエリ
```sql
SELECT
    c.channel_name AS "チャンネル名", ps.broadcasting_at AS "放送開始時刻",
		ADDTIME(TIME(ps.broadcasting_at), e.video_length) AS "放送終了時刻",
		e.season_no AS "シーズン数", e.episode_no AS "エピソード数",
		e.episode_name AS "エピソードタイトル", e.episode_detail AS "エピソード詳細"
FROM
    program_schedules AS ps INNER JOIN episodes AS e
			ON ps.episode_index = e.episode_index
		INNER JOIN channels AS c
			ON ps.channel_no = c.channel_no
WHERE
		DATE(ps.broadcasting_at) = CURDATE()
\G
```
### 結果
```
************************** 1. row ***************************
チャンネル名: アニメ
放送開始時刻: 2023-11-12 13:45:00
放送終了時刻: 14:35:30
シーズン数: 1
エピソード数: 19
エピソードタイトル: 未知なる敵への挑戦
エピソード詳細: 未来を予知する少女が未知なる敵に立ち向かうSFアニメのエピソード。
*************************** 2. row ***************************
チャンネル名: アニメ
放送開始時刻: 2023-11-12 21:00:00
放送終了時刻: 21:55:15
シーズン数: 1
エピソード数: 20
エピソードタイトル: 運命の結びつき
エピソード詳細: 少女の運命が結びつくSFアニメのエピソード。
*************************** 3. row ***************************
チャンネル名: お笑い
放送開始時刻: 2023-11-12 16:45:00
放送終了時刻: 17:30:15
シーズン数: 1
エピソード数: 14
エピソードタイトル: 芸能人大集合
エピソード詳細: バラエティ「元気が出るテレビ」の第1シーズン第14話。芸能人大集合。
*************************** 4. row ***************************
チャンネル名: お笑い
放送開始時刻: 2023-11-12 23:20:00
放送終了時刻: 23:55:10
シーズン数: 1
エピソード数: 19
エピソードタイトル: ぶっちゃけトーク開幕
エピソード詳細: トークショー「ぶっちゃけトーク」の第1シーズン第19話。率直なトークが繰り広げられる。
*************************** 5. row ***************************
チャンネル名: スポーツ
放送開始時刻: 2023-11-12 14:50:00
放送終了時刻: 15:40:30
シーズン数: 1
エピソード数: 9
エピソードタイトル: ワールドカップ熱戦の記録
エピソード詳細: ワールドカップの激戦を振り返るサッカー中継のエピソード。
*************************** 6. row ***************************
チャンネル名: スポーツ
放送開始時刻: 2023-11-12 22:15:00
放送終了時刻: 23:10:15
シーズン数: 1
エピソード数: 10
エピソードタイトル: ノックアウトステージの激闘
エピソード詳細: ワールドカップのノックアウトステージの熱戦を振り返るエピソード。
*************************** 7. row ***************************
チャンネル名: ドラマ
放送開始時刻: 2023-11-12 12:30:00
放送終了時刻: 13:18:45
シーズン数: 2
エピソード数: 18
エピソードタイトル: 影の陰謀
エピソード詳細: サスペンスドラマ「裏切りの影」の第2シーズン第18話。影の陰謀が明らかに。
*************************** 8. row ***************************
チャンネル名: ドラマ
放送開始時刻: 2023-11-12 19:30:00
放送終了時刻: 20:15:10
シーズン数: 1
エピソード数: 35
エピソードタイトル: 実録・生きていく
エピソード詳細: ドキュメンタリードラマ「実録・生きていく」の第1シーズン第35話。実録の生き様に迫る。
*************************** 9. row ***************************
チャンネル名: バラエティー
放送開始時刻: 2023-11-12 00:25:00
放送終了時刻: 01:00:10
シーズン数: 1
エピソード数: 19
エピソードタイトル: ぶっちゃけトーク開幕
エピソード詳細: トークショー「ぶっちゃけトーク」の第1シーズン第19話。率直なトークが繰り広げられる。
*************************** 10. row ***************************
チャンネル名: バラエティー
放送開始時刻: 2023-11-12 17:55:00
放送終了時刻: 18:40:15
シーズン数: 1
エピソード数: 14
エピソードタイトル: 芸能人大集合
エピソード詳細: バラエティ「元気が出るテレビ」の第1シーズン第14話。芸能人大集合。
*************************** 11. row ***************************
チャンネル名: 音楽
放送開始時刻: 2023-11-12 15:05:00
放送終了時刻: 16:00:30
シーズン数: 1
エピソード数: 10
エピソードタイトル: 驚きの瞬間
エピソード詳細: ドキュメンタリー「未知なる世界へ」の第1シーズン第10話。驚きの瞬間が満載。
*************************** 12. row ***************************
チャンネル名: 音楽
放送開始時刻: 2023-11-12 20:20:00
放送終了時刻: 21:10:30
シーズン数: 1
エピソード数: 15
エピソードタイトル: 夢の音色
エピソード詳細: 音楽ライブ「夢の音色」の第1シーズン第15話。美しい音楽に包まれる夜。
12 rows in set (0.00 sec)
```


## 4.ドラマのチャンネルの番組表を表示したい
ドラマというチャンネルがあったとして、本日から一週間分、何日の何時から何の番組が放送されるのかを知りたい。
ドラマのチャンネルに対して、放送開始時刻、放送終了時刻、シーズン数、エピソード数、エピソードタイトル、エピソード詳細を本日から一週間分取得する。
### クエリ
```sql
SELECT
    broadcasting_at AS "放送開始時刻", ADDTIME(TIME(ps.broadcasting_at), e.video_length) AS "放送終了時刻",
		e.season_no AS "シーズン数", e.episode_no AS "エピソード数", e.episode_name AS "エピソードタイトル",
		e.episode_detail AS "エピソード詳細"
FROM
    program_schedules AS ps INNER JOIN episodes AS e ON ps.episode_index = e.episode_index
WHERE
		DATE(ps.broadcasting_at) BETWEEN CURDATE() AND ADDDATE(CURDATE(), 7)
		AND channel_no = ( SELECT channel_no
												FROM channels
												WHERE channel_name = 'ドラマ'
											)
ORDER BY
	broadcasting_at ASC
\G
```
### 結果
```
************************** 1. row ***************************
放送開始時刻: 2023-11-12 12:30:00
放送終了時刻: 13:18:45
シーズン数: 2
エピソード数: 18
エピソードタイトル: 影の陰謀
エピソード詳細: サスペンスドラマ「裏切りの影」の第2シーズン第18話。影の陰謀が明らかに。
*************************** 2. row ***************************
放送開始時刻: 2023-11-12 19:30:00
放送終了時刻: 20:15:10
シーズン数: 1
エピソード数: 35
エピソードタイトル: 実録・生きていく
エピソード詳細: ドキュメンタリードラマ「実録・生きていく」の第1シーズン第35話。実録の生き様に迫る。
*************************** 3. row ***************************
放送開始時刻: 2023-11-13 12:30:00
放送終了時刻: 13:00:50
シーズン数: 1
エピソード数: 29
エピソードタイトル: 恐怖の扉
エピソード詳細: ホラードラマ「恐怖の扉」の第1シーズン第29話。ハラハラドキドキの恐怖。
*************************** 4. row ***************************
放送開始時刻: 2023-11-13 19:30:00
放送終了時刻: 20:20:45
シーズン数: 2
エピソード数: 36
エピソードタイトル: 感動の再会
エピソード詳細: ドキュメンタリードラマ「実録・生きていく」の第2シーズン第36話。感動の再会が訪れる。
*************************** 5. row ***************************
放送開始時刻: 2023-11-14 12:30:00
放送終了時刻: 13:08:20
シーズン数: 2
エピソード数: 30
エピソードタイトル: 怪奇の館
エピソード詳細: ホラードラマ「恐怖の扉」の第2シーズン第30話。怪奇の館での恐怖体験。
*************************** 6. row ***************************
放送開始時刻: 2023-11-14 19:30:00
放送終了時刻: 20:08:20
シーズン数: 1
エピソード数: 13
エピソードタイトル: 感動の映画のストーリー
エピソード詳細: 感動的な映画のストーリーに迫る映画のエピソード。
*************************** 7. row ***************************
放送開始時刻: 2023-11-15 12:30:00
放送終了時刻: 13:15:10
シーズン数: 1
エピソード数: 35
エピソードタイトル: 実録・生きていく
エピソード詳細: ドキュメンタリードラマ「実録・生きていく」の第1シーズン第35話。実録の生き様に迫る。
*************************** 8. row ***************************
放送開始時刻: 2023-11-15 19:30:00
放送終了時刻: 20:12:45
シーズン数: 1
エピソード数: 14
エピソードタイトル: 映画製作の舞台裏
エピソード詳細: 感動の映画製作の舞台裏に迫る映画のエピソード。
*************************** 9. row ***************************
放送開始時刻: 2023-11-16 12:30:00
放送終了時刻: 13:20:45
シーズン数: 2
エピソード数: 36
エピソードタイトル: 感動の再会
エピソード詳細: ドキュメンタリードラマ「実録・生きていく」の第2シーズン第36話。感動の再会が訪れる。
*************************** 10. row ***************************
放送開始時刻: 2023-11-16 19:30:00
放送終了時刻: 20:15:30
シーズン数: 1
エピソード数: 1
エピソードタイトル: 感動のはじまり
エピソード詳細: ドラマ「シェフの花園」の第1シーズン第1話。物語のはじまりにして感動のスタート。
*************************** 11. row ***************************
放送開始時刻: 2023-11-17 12:30:00
放送終了時刻: 13:08:20
シーズン数: 1
エピソード数: 13
エピソードタイトル: 感動の映画のストーリー
エピソード詳細: 感動的な映画のストーリーに迫る映画のエピソード。
*************************** 12. row ***************************
放送開始時刻: 2023-11-17 19:30:00
放送終了時刻: 20:12:20
シーズン数: 2
エピソード数: 2
エピソードタイトル: 新たな展開
エピソード詳細: ドラマ「シェフの花園」の第2シーズン第2話。新たな展開が待っている。
*************************** 13. row ***************************
放送開始時刻: 2023-11-18 12:30:00
放送終了時刻: 13:12:45
シーズン数: 1
エピソード数: 14
エピソードタイトル: 映画製作の舞台裏
エピソード詳細: 感動の映画製作の舞台裏に迫る映画のエピソード。
*************************** 14. row ***************************
放送開始時刻: 2023-11-18 19:30:00
放送終了時刻: 20:15:20
シーズン数: 1
エピソード数: 17
エピソードタイトル: 裏切りの影
エピソード詳細: サスペンスドラマ「裏切りの影」の第1シーズン第17話。緊迫感満点のストーリー。
*************************** 15. row ***************************
放送開始時刻: 2023-11-19 12:30:00
放送終了時刻: 13:15:30
シーズン数: 1
エピソード数: 1
エピソードタイトル: 感動のはじまり
エピソード詳細: ドラマ「シェフの花園」の第1シーズン第1話。物語のはじまりにして感動のスタート。
*************************** 16. row ***************************
放送開始時刻: 2023-11-19 19:30:00
放送終了時刻: 20:15:10
シーズン数: 1
エピソード数: 35
エピソードタイトル: 実録・生きていく
エピソード詳細: ドキュメンタリードラマ「実録・生きていく」の第1シーズン第35話。実録の生き様に迫る。
16 rows in set (0.04 sec)
```

## 5.直近一週間で最も見られた番組が知りたい
直近一週間に放送された番組の中で、エピソード視聴数合計トップ2の番組に対して、番組タイトル、視聴数を取得する。
### クエリ
```sql
SELECT
	p.program_name AS "番組タイトル", SUM(e.viewers) AS "視聴数"
FROM
  programs AS p INNER JOIN episodes AS e
     ON p.program_no = e.program_no
   INNER JOIN program_schedules AS ps
     ON ps.episode_index = e.episode_index
WHERE
  DATE(ps.broadcasting_at) BETWEEN ADDDATE(CURDATE(), -7) AND CURDATE()
GROUP BY
	p.program_name
ORDER BY
	SUM(e.viewers) DESc
LIMIT 2
;
```
### 結果
| 番組タイトル                                | 視聴数    |
|--------------------------------------------|-----------|
| 音楽ライブ「響きの探求者」                    |   2200000 |
| バラエティ「元気が出るテレビ」                |    664000 |

2 rows in set (0.04 sec)

## 6.ジャンルごとの番組の視聴数ランキングを知りたい
番組の視聴数ランキングはエピソードの平均視聴数ランキングとする。
ジャンルごとに視聴数トップの番組に対して、ジャンル名、番組タイトル、エピソード平均視聴数を取得する。
### クエリ
```sql
SELECT
	g1.genre_name AS "ジャンル名",
	p1.program_name AS "番組タイトル",
	AVG(e1.viewers) AS "エピソード平均視聴数"
FROM
	programs AS p1
	INNER JOIN program_genres AS pg1
		ON p1.program_no = pg1.program_no
	INNER JOIN episodes AS e1
		ON p1.program_no = e1.program_no
	INNER JOIN genres AS g1
		ON pg1.genre_no = g1.genre_no
GROUP BY
	g1.genre_name, p1.program_name
HAVING
	AVG(e1.viewers) = ( SELECT
				MAX(e_sub.avg_viewers)
				FROM
				program_genres AS pg2
					INNER JOIN episodes AS e2
						ON pg2.program_no = e2.program_no
					INNER JOIN programs AS p2
						ON p2.program_no = e2.program_no
					INNER JOIN genres AS g2
						ON g2.program_no = e2.program_no
					INNER JOIN (
							SELECT
								e3.program_no,
								AVG(e3.viewers) AS avg_viewers
							FROM
								episodes AS e3
							GROUP BY
								e3.program_no
							) AS e_sub
						ON e2.program_no = e_sub.program_no
			WHERE
				g1.genre_name = g2.genre_name
			)
;
```

### 結果
| ジャンル名               | 番組タイトル                            | エピソード平均視聴数             |
|--------------------------|--------------------------------------|--------------------------------|
| ドラマ                   | ドラマ「シェフの花園」                  |                    115000.0000 |
| 料理                     | ドラマ「シェフの花園」                  |                    115000.0000 |
| 音楽                     | 音楽ライブ「響きの探求者」              |                    550000.0000 |
| お笑い                   | バラエティ「元気が出るテレビ」           |                     94500.0000 |
| 教育                     | 自然番組「美しい地球」                  |                     94500.0000 |
| ドキュメンタリー         | ドキュメンタリードラマ「実録・生きていく」  |                    101500.0000 |
| バラエティ               | バラエティ「人気者集合」                 |                    185000.0000 |
| アニメ                   | ファンタジーアニメ「冒険者たちの物語」    |                    107500.0000 |
| スポーツ                 | サッカー中継「ワールドカップ特集」        |                    125000.0000 |
| 映画                     | 映画「感動の物語」                      |                    102500.0000 |

10 rows in set (0.01 sec)